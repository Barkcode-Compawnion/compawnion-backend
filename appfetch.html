<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application List</title>
  <style>
    #signatureCanvas {
      border: 1px solid black;
      margin-top: 20px;
    }
    #canvasContainer {
      display: none;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script>
    const baseUrl = 'http://localhost:3000';  // Ensure this is the correct backend URL
    let signatureCanvas;
    let signatureContext;
    let isDrawing = false;

    // Fetch applications from the backend
    async function fetchApplications() {
      try {
        console.log('Fetching applications...');
        const response = await fetch(`${baseUrl}/application`);

        if (!response.ok) {
          throw new Error('Failed to fetch applications');
        }

        const applications = await response.json();
        console.log('Applications:', applications);
        displayApplications(applications);
      } catch (error) {
        console.error('Error fetching applications:', error);
        alert('Error fetching applications');
      }
    }

    // Display the fetched applications in the HTML
    function displayApplications(applications) {
      const applicationsList = document.getElementById('applications-list');
      applicationsList.innerHTML = '';  // Clear any existing content

      if (applications.length === 0) {
        applicationsList.innerHTML = '<p>No applications found.</p>';
      } else {
        const ul = document.createElement('ul');
        applications.forEach((app) => {
          const li = document.createElement('li');

          // Make each application clickable by wrapping the app info in a <a> tag
          const link = document.createElement('a');
          link.href = "#";
          link.textContent = `Application ID: ${app.applicationAppId} - Applicant: ${app.applicant.name}`;
          link.onclick = () => loadApplicationForSignature(app);

          li.appendChild(link);
          ul.appendChild(li);
        });
        applicationsList.appendChild(ul);
      }
    }

    // Function to load application data and show signature canvas
    function loadApplicationForSignature(app) {
      // Display the signature canvas and hide application list
      document.getElementById('canvasContainer').style.display = 'block';
      document.getElementById('applications-list').style.display = 'none';

      // Display application details
      document.getElementById('application-details').innerHTML = ` 
        <h3>Application ID: ${app.applicationAppId}</h3>
        <p>Applicant: ${app.applicant.name}</p>
        <p>Applicant Email: ${app.applicant.email}</p>
      `;

      // Setup canvas for signature
      signatureCanvas = document.getElementById('signatureCanvas');
      signatureContext = signatureCanvas.getContext('2d');
      signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height); // Clear canvas

      // Add event listeners for drawing on the canvas only after it's loaded
      signatureCanvas.addEventListener('mousedown', startDrawing);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);
    }

    // Start drawing on the canvas
    function startDrawing(e) {
      isDrawing = true;
      signatureContext.beginPath();
      signatureContext.moveTo(e.offsetX, e.offsetY);
    }

    // Draw on the canvas
    function draw(e) {
      if (isDrawing) {
        signatureContext.lineTo(e.offsetX, e.offsetY);
        signatureContext.stroke();
      }
    }

    // Stop drawing on the canvas
    function stopDrawing() {
      isDrawing = false;
    }


// Function to save the signature and generate the PDF
async function saveSignatureAndGeneratePDF() {
  const signatureImageData = signatureCanvas.toDataURL('image/png');
  const applicationDetails = document.getElementById('application-details').innerText;

  // Extract specific details from the application details for the contract
  const applicationIdMatch = applicationDetails.match(/Application ID:\s*(\S+)/);
  const applicantNameMatch = applicationDetails.match(/Applicant:\s*(.+)/);
  const applicantEmailMatch = applicationDetails.match(/Applicant Email:\s*(.+)/); // Corrected the typo here

  const applicationId = applicationIdMatch ? applicationIdMatch[1] : 'N/A';
  const applicantName = applicantNameMatch ? applicantNameMatch[1] : 'N/A';
  const applicantEmail = applicantEmailMatch ? applicantEmailMatch[1] : 'N/A';

  // Create a new PDF document
  const pdfDoc = await PDFLib.PDFDocument.create();
  const page = pdfDoc.addPage([600, 800]);
  const { height } = page.getSize();
  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRoman);
  const fontSize = 12;

  // Define the adoption contract text
  const contractText = `
    Animal Adoption Agreement

    This agreement is made on [Date] by and between ${applicantName} (the Adopter) 
    and the Rescue Organization (the Rescue) for the adoption of an animal.

    Terms and Conditions:

    1. The Adopter agrees to provide adequate food, water, shelter, and exercise.
    2. The Adopter agrees to maintain the animal in a safe environment.
    3. The Adopter agrees to provide regular veterinary care.
    4. If the Adopter can no longer care for the animal, they agree to contact the Rescue.
    5. The adoption fee is to support the Rescue's efforts.

    By signing below, both parties agree to the terms set forth in this adoption contract.

    Adopter Name: ${applicantName}
    Adopter Email: ${applicantEmail}
    Application ID: ${applicationId}
  `;

  // Add the contract text to the PDF
  const textLines = contractText.split('\n');
  let yOffset = height - 50;
  textLines.forEach(line => {
    page.drawText(line.trim(), { x: 50, y: yOffset, size: fontSize, font });
    yOffset -= 18;
  });

  // Add "Signature:" label
  page.drawText('Signature:', { x: 50, y: yOffset - 50, size: fontSize, font });

  // Embed and position signature image
  const signatureImageBytes = await fetch(signatureImageData).then(res => res.arrayBuffer());
  const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
  const signatureWidth = 200;
  const signatureHeight = (signatureImage.height / signatureImage.width) * signatureWidth;

  page.drawImage(signatureImage, {
    x: 50,
    y: yOffset - 120, // Position signature image below contract text
    width: signatureWidth,
    height: signatureHeight
  });

  // Save the PDF as a Blob
  const pdfBytes = await pdfDoc.save();
  const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });

  // Open the PDF in a new window
  const pdfUrl = URL.createObjectURL(pdfBlob);
  const pdfWindow = window.open(pdfUrl, '_blank');

  // Add the Save button in the new window
  if (pdfWindow) {
    const saveButton = pdfWindow.document.createElement('button');
    saveButton.innerText = 'Save PDF';
    saveButton.style.position = 'absolute';
    saveButton.style.bottom = '20px';
    saveButton.style.left = '20px';
    saveButton.style.padding = '10px';
    saveButton.style.fontSize = '16px';
    saveButton.onclick = () => {
      const downloadLink = document.createElement('a');
      downloadLink.href = pdfUrl;
      downloadLink.download = `Adoption_Contract_${applicationId}.pdf`;
      downloadLink.click();
    };
    pdfWindow.document.body.appendChild(saveButton);
  }
}

  </script>
</head>
<body>
  <h1>Applications</h1>
  <button onclick="fetchApplications()">Fetch Applications</button>
  <div id="applications-list"></div>

  <!-- Container for signature canvas and details -->
  <div id="canvasContainer">
    <div id="application-details"></div>
    <canvas id="signatureCanvas" width="500" height="200"></canvas>
    <br>
    <button onclick="clearSignature()">Clear Signature</button>
    <button onclick="saveSignatureAndGeneratePDF()">Save & Generate PDF</button>
    <button onclick="document.getElementById('canvasContainer').style.display = 'none'; document.getElementById('applications-list').style.display = 'block';">Back</button>
  </div>
</body>
</html>
